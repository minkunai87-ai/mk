<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚˜ë§Œì˜ ì•ˆí‚¤ (ìë™ ìŠ¤ìº”)</title>
<style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    :root { --primary: #4dabf7; --bg: #f8f9fa; --text: #343a40; }
    body { font-family: 'Apple SD Gothic Neo', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    /* í—¤ë” */
    .header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; height: 60px; flex-shrink: 0; }
    .header-title { font-weight: bold; font-size: 1.2rem; color: var(--text); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 50%; }
    .header-controls { display: flex; gap: 10px; align-items: center; }
    .menu-btn { font-size: 1.8rem; cursor: pointer; background: none; border: none; padding: 0; color: #495057; }
    .counter { font-size: 0.9rem; font-weight: bold; color: #868e96; background: #e9ecef; padding: 5px 12px; border-radius: 15px; }

    /* ì‚¬ì´ë“œë°” */
    .sidebar { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: 0.3s; z-index: 100; padding: 25px; display: flex; flex-direction: column; overflow-y: auto; }
    .sidebar.open { left: 0; }
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; display: none; }
    .sidebar-overlay.open { display: block; }
    
    .menu-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .menu-label { font-weight: bold; color: #495057; margin-bottom: 10px; display: block; }
    
    .search-box { position: relative; margin-bottom: 15px; }
    .search-input { width: 100%; padding: 12px 10px 12px 35px; border: 2px solid #ced4da; border-radius: 8px; font-size: 0.95rem; box-sizing: border-box; transition: 0.2s; }
    .search-input:focus { border-color: var(--primary); outline: none; }
    .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #adb5bd; }

    /* ë± ë¦¬ìŠ¤íŠ¸ & í´ë” ìŠ¤íƒ€ì¼ */
    .deck-list { list-style: none; padding: 0; margin: 0; }
    .deck-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; background: #f1f3f5; transition: 0.2s; font-size: 0.95rem; }
    .deck-item:hover { background: #e9ecef; }
    .deck-item.active { background: #e7f5ff; color: #1971c2; font-weight: bold; border: 1px solid #1971c2; }
    
    .folder-header { padding: 10px 12px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; background: #fff9db; color: #495057; font-weight: bold; border: 1px solid #f0e6cc; }
    .folder-header:hover { background: #fff3bf; }
    
    .folder-content { display: none; padding-left: 15px; border-left: 2px solid #eee; margin-left: 10px; margin-bottom: 10px; }
    .folder-content.open { display: block; }
    .folder-content .deck-item { background: white; border: 1px solid #eee; font-size: 0.9rem; }
    .folder-content .deck-item:hover { background: #f8f9fa; }
    .folder-content .deck-item.active { background: #e7f5ff; border: 1px solid #1971c2; }

    .deck-del-btn { background: none; border: none; color: #adb5bd; font-weight: bold; padding: 0 5px; cursor: pointer; }
    .deck-del-btn:hover { color: #ff6b6b; }

    .btn-upload { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-bottom: 8px; }
    .btn-upload:hover { background: #339af0; }
    .sort-btn { width: 100%; padding: 10px; margin-bottom: 8px; background: white; border: 1px solid #ced4da; border-radius: 6px; cursor: pointer; text-align: left; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .sort-btn:hover { background: #f8f9fa; border-color: #adb5bd; }

    /* ë©”ì¸ ì˜ì—­ */
    .main-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; width: 100%; box-sizing: border-box; position: relative; overflow: hidden; }
    .card { background: white; width: 100%; max-width: 600px; height: 100%; max-height: 700px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); display: flex; flex-direction: column; position: relative; overflow: hidden; border: 1px solid #dee2e6; }
    .card-scroll-area { flex: 1; padding: 25px; overflow-y: auto; scrollbar-width: thin; }
    
    .card-info { display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #eee; align-items: center; }
    .rate-badge { font-size: 0.85rem; font-weight: bold; padding: 5px 10px; border-radius: 6px; background: #eee; color: #666; }
    .rate-badge.high { background: #d3f9d8; color: #2b8a3e; }
    .rate-badge.low { background: #ffe3e3; color: #c92a2a; }
    
    .icon-wrapper { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
    .icon-row { display: flex; gap: 10px; }
    .icon-btn { font-size: 1.3rem; cursor: pointer; background: none; border: none; padding: 0; line-height: 1; color: #dee2e6; transition: 0.2s; opacity: 0.3; filter: grayscale(100%); }
    .icon-btn:hover { opacity: 0.7; }
    .icon-btn.active { opacity: 1; filter: grayscale(0%); transform: scale(1.1); }
    
    .mem-btn.active { color: #e64980; } .cmp-btn.active { color: #228be6; } .fav-btn.active { color: #fcc419; }
    .num-btn.active { color: #1098ad; } .date-btn.active { color: #845ef7; } .pen-btn.active { color: #e03131; }
    
    .edit-btn { font-size: 1.1rem; margin-right: 5px; opacity: 1; color: #868e96; }

    .text-area { font-size: 1.3rem; line-height: 1.6; word-break: keep-all; white-space: pre-wrap; width: 100%; margin-bottom: 20px; color: #212529; }
    .img-area img { max-width: 100%; max-height: 300px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin: 10px 0; display: block; margin-left: auto; margin-right: auto; }

    .divider { display: none; border: 0; border-top: 2px dashed #dee2e6; margin: 30px 0; position: relative; }
    .divider::after { content: "ì •ë‹µ"; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; color: #adb5bd; font-size: 0.8rem; font-weight: bold; }
    
    #answer-section { display: none; padding-bottom: 20px; animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .footer { width: 100%; padding: 15px 20px; background: white; border-top: 1px solid #dee2e6; z-index: 10; display: flex; flex-direction: column; gap: 10px; justify-content: center; flex-shrink: 0; }
    .nav-btns, .grade-btns { display: flex; justify-content: space-between; width: 100%; max-width: 600px; margin: 0 auto; }
    .nav-btn { flex: 1; background: white; border: 1px solid #ced4da; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #495057; transition: 0.2s; margin: 0 5px; }
    .nav-btn:hover { background: #f1f3f5; border-color: #adb5bd; }
    .grade-btns { display: none; margin-bottom: 5px; } 
    .g-btn { flex: 1; padding: 15px; border: none; border-radius: 10px; font-weight: bold; color: white; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s; margin: 0 5px; }
    .g-btn:active { transform: scale(0.98); }
    .bg-x { background: #ff6b6b; } .bg-tri { background: #fcc419; } .bg-o { background: #51cf66; }

    .click-guide { text-align: center; color: #adb5bd; font-size: 0.9rem; margin-top: 30px; cursor: pointer; padding: 20px; border: 1px dashed #dee2e6; border-radius: 10px; }
    .click-guide:hover { background: #f8f9fa; color: var(--primary); border-color: var(--primary); }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; }
    .modal-content { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px; }
    .modal-title { font-weight: bold; font-size: 1.2rem; color: #343a40; }
    .edit-label { font-size: 0.9rem; color: #868e96; font-weight: bold; }
    .edit-input { width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 8px; font-family: inherit; font-size: 1rem; resize: vertical; min-height: 80px; box-sizing: border-box; }
    .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
    .modal-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
    .btn-save { background: var(--primary); color: white; } .btn-cancel { background: #e9ecef; color: #495057; }
    
    #loading { margin-top: 50%; color: #888; text-align: center; }
</style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <h2 style="margin-top:0; color:#343a40;">âš™ï¸ ë©”ë‰´</h2>
        
        <div class="menu-section">
            <span class="menu-label">ğŸ” ì¹´ë“œ ê²€ìƒ‰</span>
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="search-input" class="search-input" placeholder="í‚¤ì›Œë“œ ì…ë ¥" onkeyup="filterCards()">
            </div>
        </div>

        <div class="menu-section">
            <span class="menu-label">í•„í„° ë° ëª¨ì•„ë³´ê¸°</span>
            <button class="sort-btn" onclick="sortCards('default')"><span>ğŸ“‹ ì „ì²´ ë³´ê¸° (ê¸°ë³¸)</span></button>
            <div style="height:10px;"></div>
            <button class="sort-btn" onclick="sortCards('mem')"><span>ğŸ§  ì•”ê¸°ì¥ ëª¨ìŒ</span></button>
            <button class="sort-btn" onclick="sortCards('cmp')"><span>ğŸ†š ë¹„êµë¬¸ì œ ëª¨ìŒ</span></button>
            <button class="sort-btn" onclick="sortCards('fav')"><span>â­ ì¤‘ìš”(ë³„í‘œ) ëª¨ìŒ</span></button>
            <div style="height:10px;"></div>
            <button class="sort-btn" onclick="sortCards('num')"><span>ğŸ”¢ ìˆ«ìë¬¸ì œ ëª¨ìŒ</span></button>
            <button class="sort-btn" onclick="sortCards('date')"><span>ğŸ“… ë‚ ì§œ/ê¸°í•œ ëª¨ìŒ</span></button>
            <button class="sort-btn" onclick="sortCards('pen')"><span>ğŸš¨ ë²Œì¹™/ë²Œê¸ˆ ëª¨ìŒ</span></button>
            <div style="height:10px;"></div>
            <button class="sort-btn" style="border-color:#ff6b6b; color:#c92a2a;" onclick="sortCards('rate_asc')"><span>ğŸ”¥ ì˜¤ë‹µ ë…¸íŠ¸</span></button>
        </div>

        <div class="menu-section">
            <span class="menu-label">ë± ê´€ë¦¬ (í´ë” ì§€ì›)</span>
            <div style="font-size:0.8rem; color:#868e96; margin-bottom:5px;">
                * <b>minkunai87-ai/mk</b> ì €ì¥ì†Œì˜ íŒŒì¼ì„<br>ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. (1~2ë¶„ ì†Œìš”)
            </div>
            <button class="btn-upload" onclick="document.getElementById('file-input').click()">+ (ë¡œì»¬) í…ìŠ¤íŠ¸ íŒŒì¼ ì¶”ê°€</button>
            <input type="file" id="file-input" accept=".txt" multiple style="display:none" onchange="handleFileUpload(this)">
            <ul class="deck-list" id="deck-list-ui"></ul>
        </div>

        <div class="menu-section">
            <span class="menu-label">ì´ë¯¸ì§€ ì„¤ì •</span>
            <button class="btn-upload" style="background:#20c997;" onclick="document.getElementById('img-input').click()">ğŸ–¼ï¸ ì´ë¯¸ì§€ í´ë” ì—°ê²°</button>
            <input type="file" id="img-input" webkitdirectory directory multiple style="display:none" onchange="handleImgUpload(this)">
        </div>
        
        <div style="margin-top:auto; font-size:0.8rem; color:#adb5bd; text-align:center;">
            My Anki v9.0 (Auto-Scan)
        </div>
    </div>

    <div class="header">
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <div class="header-title" id="deck-title">ë‚˜ë§Œì˜ ì•ˆí‚¤</div>
        <div class="header-controls">
            <span class="counter" id="card-counter">0 / 0</span>
        </div>
    </div>

    <div class="main-container">
        <div class="card">
            <div class="card-scroll-area" id="scroll-area">
                <div id="loading" style="display:none;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                
                <div class="card-info" id="card-info">
                    <span class="rate-badge" id="rate-badge">New</span>
                    <div class="icon-wrapper">
                        <div class="icon-row">
                            <button class="icon-btn edit-btn" onclick="openEditModal(event)">âœï¸</button>
                            <button class="icon-btn mem-btn" id="mem-btn" onclick="toggleTag(event, 'mem')" title="ì•”ê¸°">ğŸ§ </button>
                            <button class="icon-btn cmp-btn" id="cmp-btn" onclick="toggleTag(event, 'cmp')" title="ë¹„êµ">ğŸ†š</button>
                            <button class="icon-btn fav-btn" id="fav-btn" onclick="toggleTag(event, 'fav')" title="ì¤‘ìš”">â­</button>
                        </div>
                        <div class="icon-row">
                            <button class="icon-btn num-btn" id="num-btn" onclick="toggleTag(event, 'num')" title="ìˆ«ì">ğŸ”¢</button>
                            <button class="icon-btn date-btn" id="date-btn" onclick="toggleTag(event, 'date')" title="ë‚ ì§œ">ğŸ“…</button>
                            <button class="icon-btn pen-btn" id="pen-btn" onclick="toggleTag(event, 'pen')" title="ë²Œì¹™">ğŸš¨</button>
                        </div>
                    </div>
                </div>

                <div id="question-section" class="content-box">
                    <h3 style="color:#868e96;" id="guide-msg">ğŸ‘ˆ ë©”ë‰´ì—ì„œ íŒŒì¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</h3>
                </div>

                <div id="click-guide" class="click-guide" onclick="revealAnswer()">
                    ğŸ‘‡ í„°ì¹˜í•˜ì—¬ ì •ë‹µ í™•ì¸
                </div>

                <hr id="divider" class="divider">

                <div id="answer-section" class="content-box"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="grade-btns" id="grade-area">
            <button class="g-btn bg-x" onclick="grade(0)">ëª¨ë¦„</button>
            <button class="g-btn bg-tri" onclick="grade(1)">ì• ë§¤</button>
            <button class="g-btn bg-o" onclick="grade(2)">ë§ìŒ</button>
        </div>
        <div class="nav-btns" id="nav-area">
            <button class="nav-btn" onclick="moveCard(-1)">â—€ ì´ì „</button>
            <button class="nav-btn" onclick="moveCard(1)">ë‹¤ìŒ â–¶</button>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“ ì¹´ë“œ ìˆ˜ì •</div>
            <div><span class="edit-label">ì§ˆë¬¸ (Front)</span><textarea id="edit-q" class="edit-input"></textarea></div>
            <div><span class="edit-label">ì •ë‹µ (Back)</span><textarea id="edit-a" class="edit-input"></textarea></div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeEditModal()">ì·¨ì†Œ</button>
                <button class="modal-btn btn-save" onclick="saveEdit()">ì €ì¥</button>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // ğŸ‘‘ GitHub ìë™ ìŠ¤ìº” ì„¤ì •
    const repoOwner = 'minkunai87-ai';
    const repoName = 'mk';
    // ==========================================

    let library = {}, currentDeckName = null, originalDeck = [], activeDeck = [], currentIndex = 0;
    let imageMap = new Map(), isRevealed = false;
    const STORAGE_KEY_LIBRARY = 'anki_final_library';
    const STORAGE_KEY_STATS = 'anki_final_stats';
    const STORAGE_KEY_EDITS = 'anki_final_edits';
    const STORAGE_KEY_PROGRESS = 'anki_final_progress';

    window.onload = async function() {
        if (location.protocol.startsWith('http')) { await autoScanGitHub(); }
        else { loadLocalLibrary(); }
    };

    function loadLocalLibrary() {
        const savedLib = localStorage.getItem(STORAGE_KEY_LIBRARY);
        if (savedLib) {
            try {
                library = JSON.parse(savedLib);
                renderDeckList();
                const keys = Object.keys(library);
                if (keys.length > 0) selectDeck(keys[0]);
            } catch(e) {}
        }
    }

    // === ğŸ”¥ GitHub API ìë™ ìŠ¤ìº” ===
    async function autoScanGitHub() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('question-section').style.display = 'none';
        
        let loadedCount = 0;
        const edits = JSON.parse(localStorage.getItem(STORAGE_KEY_EDITS) || '{}');

        try {
            // GitHub APIë¡œ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const listUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/`;
            const listResponse = await fetch(listUrl);
            if (!listResponse.ok) throw new Error("Repo access failed");
            
            const files = await listResponse.json();
            
            // .txt íŒŒì¼ë§Œ ê³¨ë¼ë‚´ê¸°
            const txtFiles = files.filter(f => f.name.endsWith('.txt'));

            // ê° íŒŒì¼ ë‚´ìš© ì½ì–´ì˜¤ê¸°
            for (const file of txtFiles) {
                try {
                    // ìºì‹œ ë°©ì§€ìš© ì‹œê°„ ì¶”ê°€
                    const contentResponse = await fetch(file.download_url + '?t=' + new Date().getTime());
                    const text = await contentResponse.text();
                    
                    let deckName = file.name.replace('.txt', '');
                    try { deckName = decodeURIComponent(deckName); } catch(e){}

                    const parsed = parseAnkiFile(text);
                    library[deckName] = parsed.map(c => {
                        const id = cyrb53(c.q);
                        if (edits[id]) return { id, q: edits[id].q, a: edits[id].a };
                        return { id, q: c.q, a: c.a };
                    });
                    loadedCount++;
                } catch (e) { console.error("Error reading file:", file.name); }
            }

        } catch (error) {
            console.error("Auto scan failed:", error);
            // ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë°©ì‹(ìˆ˜ë™ ëª©ë¡) ì‹œë„ (í˜¹ì‹œ ëª°ë¼ì„œ)
            // const fallbackFiles = ['data.txt']; // í•„ìš”í•œ ê²½ìš° í™œì„±í™”
        }

        renderDeckList();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('question-section').style.display = 'block';
        
        if (loadedCount > 0) {
            // ì €ì¥ëœ ë§ˆì§€ë§‰ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ê·¸ ë±ì„, ì—†ìœ¼ë©´ ì²«ë²ˆì§¸ ë±ì„ ì„ íƒ
            const progress = JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESS) || '{}');
            const lastDeck = Object.keys(progress).find(key => library[key]); 
            if(lastDeck) selectDeck(lastDeck);
            else selectDeck(Object.keys(library)[0]);
        } else {
            document.getElementById('question-section').innerHTML = "<h3>âš ï¸ ë¶ˆëŸ¬ì˜¬ ë±ì´ ì—†ìŠµë‹ˆë‹¤.</h3><p>GitHubì— .txt íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.</p>";
        }
    }

    function renderDeckList() {
        const list = document.getElementById('deck-list-ui');
        list.innerHTML = '';
        const names = Object.keys(library).sort();

        if (names.length === 0) {
            list.innerHTML = '<li class="deck-item" style="justify-content:center;">ë± ì—†ìŒ</li>';
            return;
        }

        const groups = {};
        const others = [];

        names.forEach(name => {
            const match = name.match(/^(.+)__(.+)$/);
            if (match) {
                const folderName = match[1];
                const realDeckName = match[2];
                if (!groups[folderName]) groups[folderName] = [];
                groups[folderName].push({ originalKey: name, displayName: realDeckName });
            } else {
                others.push({ originalKey: name, displayName: name });
            }
        });

        for (const folderName in groups) {
            const folderHeader = document.createElement('li');
            folderHeader.className = 'folder-header';
            folderHeader.innerHTML = `<span>ğŸ“‚ ${folderName}</span>`;
            
            const folderContent = document.createElement('ul');
            folderContent.className = 'folder-content deck-list';
            
            folderHeader.onclick = () => { folderContent.classList.toggle('open'); };

            groups[folderName].forEach(deck => {
                const li = createDeckItem(deck.originalKey, deck.displayName);
                folderContent.appendChild(li);
            });

            list.appendChild(folderHeader);
            list.appendChild(folderContent);
        }

        others.forEach(deck => {
            const li = createDeckItem(deck.originalKey, deck.displayName);
            list.appendChild(li);
        });
    }

    function createDeckItem(key, displayName) {
        const li = document.createElement('li');
        li.className = `deck-item ${key === currentDeckName ? 'active' : ''}`;
        
        const spanName = document.createElement('span');
        spanName.innerText = `${displayName} (${library[key].length})`;
        spanName.style.flex = "1";
        spanName.onclick = () => selectDeck(key);

        const btnDel = document.createElement('button');
        btnDel.className = 'deck-del-btn';
        btnDel.innerText = 'x';
        btnDel.onclick = (e) => { e.stopPropagation(); deleteDeck(key); };

        li.appendChild(spanName);
        li.appendChild(btnDel);
        return li;
    }

    function toggleMenu() {
        document.getElementById('sidebar').classList.toggle('open');
        document.querySelector('.sidebar-overlay').classList.toggle('open');
    }

    function filterCards() {
        const query = document.getElementById('search-input').value.toLowerCase();
        if(!currentDeckName) return;
        if(!query) { activeDeck = [...originalDeck]; }
        else {
            activeDeck = originalDeck.filter(card => 
                card.q.toLowerCase().includes(query) || 
                card.a.toLowerCase().includes(query)
            );
        }
        currentIndex = 0; showCard();
    }

    function handleFileUpload(input) {
        const files = input.files;
        if (files.length === 0) return;
        let processedCount = 0;
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const parsed = parseAnkiFile(text);
                const deckName = file.name.replace('.txt', '');
                library[deckName] = parsed.map(c => ({ id: cyrb53(c.q), q: c.q, a: c.a }));
                processedCount++;
                if (processedCount === files.length) {
                    saveLibrary(); renderDeckList();
                    if (!currentDeckName) selectDeck(deckName);
                    alert(`ì´ ${files.length}ê°œ ë± ì¶”ê°€ë¨`); toggleMenu();
                }
            };
            reader.readAsText(file, 'UTF-8');
        });
        input.value = '';
    }

    function saveLibrary() { try { localStorage.setItem(STORAGE_KEY_LIBRARY, JSON.stringify(library)); } catch(e){} }

    function deleteDeck(name) {
        if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            delete library[name]; saveLibrary(); renderDeckList();
            if(currentDeckName === name) { currentDeckName=null; activeDeck=[]; showCard(); }
        }
    }

    function selectDeck(name) {
        if(!library[name]) return;
        currentDeckName = name; 
        originalDeck = library[name]; 
        activeDeck = [...originalDeck];
        
        const progress = JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESS) || '{}');
        currentIndex = progress[name] || 0;
        if(currentIndex >= activeDeck.length) currentIndex = 0;

        isRevealed = false;
        document.getElementById('search-input').value = ''; 
        const displayName = name.includes('__') ? name.split('__')[1] : name;
        document.getElementById('deck-title').innerText = displayName;
        
        renderDeckList(); showCard();
        document.getElementById('sidebar').classList.remove('open');
        document.querySelector('.sidebar-overlay').classList.remove('open');
    }

    function saveCurrentProgress() {
        if (!currentDeckName) return;
        if (activeDeck.length === originalDeck.length) {
            const progress = JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESS) || '{}');
            progress[currentDeckName] = currentIndex;
            localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify(progress));
        }
    }

    function handleImgUpload(input) {
        const files = input.files; if(files.length === 0) return;
        imageMap.clear();
        for(let file of files) {
            const url = URL.createObjectURL(file);
            imageMap.set(file.name, url);
            imageMap.set(file.name.normalize('NFC'), url);
            imageMap.set(file.name.normalize('NFD'), url);
        }
        alert(`${files.length}ê°œ ì´ë¯¸ì§€ ì—°ê²°ë¨`); showCard(); toggleMenu();
    }

    function openEditModal(e) {
        e.stopPropagation(); if(!activeDeck || activeDeck.length === 0) return;
        const card = activeDeck[currentIndex];
        document.getElementById('edit-q').value = card.q;
        document.getElementById('edit-a').value = card.a;
        document.getElementById('edit-modal').style.display = 'flex';
    }
    function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }
    function saveEdit() {
        const newQ = document.getElementById('edit-q').value;
        const newA = document.getElementById('edit-a').value;
        const card = activeDeck[currentIndex];
        card.q = newQ; card.a = newA;
        if (location.protocol.startsWith('http')) {
            const edits = JSON.parse(localStorage.getItem(STORAGE_KEY_EDITS) || '{}');
            edits[card.id] = { q: newQ, a: newA };
            localStorage.setItem(STORAGE_KEY_EDITS, JSON.stringify(edits));
        } else { saveLibrary(); }
        closeEditModal(); showCard(); alert("ìˆ˜ì • ì™„ë£Œ");
    }

    function parseAnkiFile(text) {
        const result = []; let currentRow = [], currentField = '', inQuote = false;
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const next = text[i+1];
            if (inQuote) {
                if (char === '"' && next === '"') { currentField += '"'; i++; }
                else if (char === '"') inQuote = false;
                else currentField += char;
            } else {
                if (char === '"') inQuote = true;
                else if (char === '\t') { currentRow.push(currentField); currentField = ''; }
                else if (char === '\n' || char === '\r') {
                    if (char === '\r' && next === '\n') i++;
                    currentRow.push(currentField);
                    if (currentRow.length >= 2) {
                        const q = currentRow[0];
                        const a = currentRow.slice(1).join('<br><br>');
                        result.push({ q, a });
                    }
                    currentRow = []; currentField = '';
                } else currentField += char;
            }
        }
        if (currentField || currentRow.length > 0) {
            currentRow.push(currentField);
            if(currentRow.length >= 2) {
                const q = currentRow[0];
                const a = currentRow.slice(1).join('<br><br>');
                result.push({ q, a });
            }
        }
        return result;
    }

    function createDOM(rawText, isAnswer) {
        let images = [];
        let regex = /([a-zA-Z0-9_\-\.\%\(\)\s\uAC00-\uD7A3]+\.(jpg|jpeg|png|gif|webp|svg))/gi;
        let match;
        while ((match = regex.exec(rawText)) !== null) {
            let fname = match[0].trim().split('/').pop().split('\\').pop();
            if(fname.length > 4) images.push(fname);
        }
        let text = rawText.replace(/<[^>]*>/g, "").replace(/""\/>/g, "").replace(/""/g, '"').replace(/^"|"$/g, '').trim();

        const wrapper = document.createElement('div'); wrapper.className = 'answer-layout';
        const txtDiv = document.createElement('div'); txtDiv.className = 'text-area'; txtDiv.innerText = text;
        const imgDiv = document.createElement('div'); imgDiv.className = 'img-area';
        
        [...new Set(images)].forEach(filename => {
            const img = document.createElement('img');
            try { filename = decodeURIComponent(filename); } catch(e){}
            if (location.protocol.startsWith('http')) {
                img.src = "./images/" + filename;
            } else {
                let url = imageMap.get(filename) || imageMap.get(filename.normalize('NFC')) || imageMap.get(filename.normalize('NFD'));
                if(url) img.src = url;
                else { img.alt="ì´ë¯¸ì§€ ì—°ê²° í•„ìš”"; img.style.border="2px dashed #ff6b6b"; img.style.color="#ff6b6b"; }
            }
            imgDiv.appendChild(img);
        });

        if (!isAnswer) { 
            if (images.length > 0) wrapper.appendChild(imgDiv); 
            if (text) wrapper.appendChild(txtDiv); 
        }
        else { 
            if (text) wrapper.appendChild(txtDiv); 
            if (images.length > 0) wrapper.appendChild(imgDiv); 
        }
        return wrapper;
    }

    function showCard() {
        if (!activeDeck || activeDeck.length === 0) {
            document.getElementById('question-section').innerHTML = "<h3 style='color:#adb5bd'>í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</h3>";
            document.getElementById('card-info').style.display='none';
            return;
        }
        if(currentIndex >= activeDeck.length) currentIndex = 0;
        
        isRevealed = false;
        const card = activeDeck[currentIndex];
        const stats = getStats(card.id);
        
        document.getElementById('card-counter').innerText = `${currentIndex + 1} / ${activeDeck.length}`;
        document.getElementById('card-info').style.display='flex';
        updateStatsUI(stats); updateIconsUI(stats);

        const qSection = document.getElementById('question-section'); qSection.innerHTML = '';
        qSection.appendChild(createDOM(card.q, false));
        
        const aSection = document.getElementById('answer-section'); aSection.innerHTML = '';
        aSection.appendChild(createDOM(card.a, true));
        
        aSection.style.display = 'none';
        document.getElementById('divider').style.display = 'none';
        document.getElementById('click-guide').style.display = 'block';
        
        document.getElementById('nav-area').style.display = 'flex';
        document.getElementById('grade-area').style.display = 'none';
        
        document.getElementById('scroll-area').scrollTop = 0;
    }

    function revealAnswer() {
        isRevealed = true;
        document.getElementById('click-guide').style.display = 'none';
        document.getElementById('divider').style.display = 'block';
        document.getElementById('answer-section').style.display = 'block';
        document.getElementById('grade-area').style.display = 'flex';
        setTimeout(() => { document.getElementById('answer-section').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
    }

    function moveCard(delta) {
        let nextIdx = currentIndex + delta;
        if(nextIdx >= 0 && nextIdx < activeDeck.length) { 
            currentIndex = nextIdx; 
            saveCurrentProgress(); 
            showCard(); 
        }
    }
    
    function grade(score) {
        saveStats(activeDeck[currentIndex].id, score);
        if (currentIndex < activeDeck.length - 1) { 
            currentIndex++; 
            saveCurrentProgress(); 
            showCard(); 
        }
        else { alert("ë!"); currentIndex=0; saveCurrentProgress(); showCard(); }
    }
    
    function getStats(id) { 
        return JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || '{}')[id] || { correct: 0, total: 0, fav: false, mem: false, cmp: false, num: false, date: false, pen: false }; 
    }
    function saveStats(id, score) {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || '{}');
        if(!data[id]) data[id] = { correct: 0, total: 0, fav: false, mem: false, cmp: false, num: false, date: false, pen: false };
        data[id].total++;
        if(score === 2) data[id].correct++; else if(score === 1) data[id].correct += 0.5;
        localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(data));
        updateStatsUI(data[id]);
    }

    function toggleTag(e, type) {
        e.stopPropagation();
        const card = activeDeck[currentIndex];
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || '{}');
        if(!data[card.id]) data[card.id] = { correct: 0, total: 0, fav: false, mem: false, cmp: false, num: false, date: false, pen: false };
        data[card.id][type] = !data[card.id][type];
        localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(data));
        updateIconsUI(data[card.id]);
    }

    function updateStatsUI(stats) {
        const badge = document.getElementById('rate-badge');
        if(stats.total === 0) { badge.innerText = "New"; badge.className = "rate-badge"; }
        else {
            const rate = Math.round((stats.correct/stats.total)*100);
            badge.innerText = `${rate}% (${stats.total}íšŒ)`;
            badge.className = `rate-badge ${rate>=80?'high':(rate<50?'low':'')}`;
        }
    }

    function updateIconsUI(stats) {
        document.getElementById('mem-btn').classList.toggle('active', stats.mem);
        document.getElementById('cmp-btn').classList.toggle('active', stats.cmp);
        document.getElementById('fav-btn').classList.toggle('active', stats.fav);
        document.getElementById('num-btn').classList.toggle('active', stats.num);
        document.getElementById('date-btn').classList.toggle('active', stats.date);
        document.getElementById('pen-btn').classList.toggle('active', stats.pen);
    }

    function sortCards(type) {
        if(!currentDeckName) return;
        const allStats = JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || '{}');
        let newDeck = [...originalDeck];

        if(type === 'rate_asc') {
            newDeck.sort((a,b) => {
                const sA = allStats[a.id] || {correct:0, total:0};
                const sB = allStats[b.id] || {correct:0, total:0};
                const rA = sA.total===0?100:(sA.correct/sA.total);
                const rB = sB.total===0?100:(sB.correct/sB.total);
                return rA - rB;
            });
            alert("ğŸ”¥ ì˜¤ë‹µ ìœ„ì£¼ ì •ë ¬");
        } else if (type === 'default') {
            // ê¸°ë³¸
        } else {
            newDeck = newDeck.filter(c => (allStats[c.id] || {})[type]);
            if(newDeck.length === 0) { alert("í•´ë‹¹í•˜ëŠ” ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        }
        
        activeDeck = newDeck; currentIndex = 0; showCard();
        document.getElementById('sidebar').classList.remove('open');
        document.querySelector('.sidebar-overlay').classList.remove('open');
    }

    const cyrb53 = (str, seed = 0) => {
        let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
        for (let i = 0, ch; i < str.length; i++) {
            ch = str.charCodeAt(i);
            h1 = Math.imul(h1 ^ ch, 2654435761);
            h2 = Math.imul(h2 ^ ch, 1597334677);
        }
        h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507) ^ Math.imul(h2 ^ (h2 >>> 13), 3266489909);
        return 4294967296 * (2097151 & h2) + (h1 >>> 0);
    };
</script>
</body>
</html>