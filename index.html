<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<title>ë‚˜ë§Œì˜ ì•ˆí‚¤ (ì´ë¯¸ì§€ ë³µêµ¬)</title>
<style>
    /* v10.45 ë””ìì¸ ì—”ì§„ ìœ ì§€ (ì‹¬í”Œ ë©”ë‰´, ì˜¤ë‹µ ì •ë ¬ ë“±) */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root { --primary: #4dabf7; --bg: #121212; --surface: #1e1e1e; --text: #e0e0e0; --text-sub: #a0a0a0; --border: #333333; --input-bg: #2c2c2c; --btn-hover: #383838; }
    body { font-family: 'Apple SD Gothic Neo', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
    
    .header { background: var(--surface); padding: 0 20px; padding-top: calc(env(safe-area-inset-top) + 15px); padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); z-index: 10; flex-shrink: 0; }
    .header-title-area { display: flex; flex-direction: column; max-width: 70%; }
    .header-title { font-weight: bold; font-size: 1.15rem; color: var(--text); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .header-subtitle { font-size: 0.75rem; color: var(--primary); margin-top: 2px; font-weight: bold; }
    .menu-btn { font-size: 1.6rem; cursor: pointer; background: none; border: none; padding: 0; color: var(--text); }
    .counter { font-size: 0.85rem; font-weight: bold; color: var(--text-sub); background: var(--input-bg); padding: 5px 12px; border-radius: 15px; }

    .sidebar { position: fixed; top: 0; left: 0; width: 300px; height: 100%; background: var(--surface); border-right: 1px solid var(--border); box-shadow: 2px 0 15px rgba(0,0,0,0.5); transition: transform 0.3s ease; z-index: 9999; padding: 25px; padding-top: calc(env(safe-area-inset-top) + 25px); display: flex; flex-direction: column; overflow-y: auto; transform: translateX(-105%); }
    .sidebar.open { transform: translateX(0); }
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9998; display: none; }
    .sidebar-overlay.open { display: block; }
    
    .menu-section { margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
    .menu-label { font-weight: bold; color: var(--text-sub); margin-bottom: 10px; display: block; font-size: 0.9rem; }
    
    .filter-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .filter-btn { padding: 10px; border-radius: 8px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); font-size: 0.85rem; cursor: pointer; text-align: left; transition: 0.2s; }
    .filter-btn.active { border-color: var(--primary); background: #182836; color: #74c0fc; }

    .sort-options { display: flex; background: var(--input-bg); border-radius: 8px; padding: 4px; gap: 4px; }
    .sort-opt { flex: 1; text-align: center; padding: 8px 0; font-size: 0.8rem; cursor: pointer; border-radius: 6px; color: var(--text-sub); transition: 0.2s; }
    .sort-opt.active { background: var(--surface); color: var(--primary); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    .search-input { width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); border-radius: 8px; font-size: 0.95rem; margin-bottom: 10px; }
    .btn-upload { width: 100%; padding: 12px; border-radius: 8px; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
    .btn-sub { width: 100%; padding: 10px; border-radius: 8px; background: var(--input-bg); color: var(--text-sub); border: 1px solid var(--border); margin-top: 5px; cursor: pointer; text-align: left; font-size: 0.85rem; }
    .deck-list { list-style: none; padding: 0; margin: 0; }
    .tree-deck { padding: 12px; border-radius: 8px; cursor: pointer; background: var(--input-bg); margin-bottom: 4px; color: var(--text); font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
    .tree-deck.active { background: #182836; color: #74c0fc; font-weight: bold; border: 1px solid #1c7ed6; }

    .main-container { flex: 1; display: flex; flex-direction: column; padding: 0; width: 100%; position: relative; overflow: hidden; background: var(--bg); }
    .card { background: var(--surface); width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }
    
    .card-scroll-area { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; touch-action: pan-y; -webkit-overflow-scrolling: touch; }
    .zoom-content { padding: 25px 20px; min-height: 100%; width: 100%; transform-origin: 0 0; will-change: transform; }
    
    .card-info { display: flex; justify-content: space-between; width: 100%; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed var(--border); align-items: center; }
    .rate-badge { font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 6px; background: var(--input-bg); color: var(--text-sub); }
    .date-badge { font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 6px; margin-left: 6px; background: var(--input-bg); color: var(--text-sub); }
    .date-badge.today { background: #1971c2; color: #e7f5ff; }
    
    .icon-wrapper { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
    .icon-row { display: flex; gap: 12px; }
    .icon-btn { font-size: 1.4rem; cursor: pointer; background: none; border: none; padding: 0; opacity: 0.4; filter: grayscale(100%); transition: 0.2s; }
    .icon-btn.active { opacity: 1; filter: grayscale(0%); transform: scale(1.1); }
    .mem-btn.active { color: #ff8787; } .cmp-btn.active { color: #74c0fc; } .fav-btn.active { color: #ffd43b; }
    .num-btn.active { color: #66d9e8; } .date-btn.active { color: #b197fc; } .pen-btn.active { color: #ff6b6b; }
    .edit-btn { font-size: 1.2rem; margin-right: 5px; opacity: 1; color: var(--text-sub); }

    .text-area { font-size: 1.35rem; line-height: 1.6; word-break: keep-all; white-space: pre-wrap; width: 100%; margin-bottom: 20px; position: relative; }
    .text-area * { max-width: 100% !important; box-sizing: border-box !important; }
    table { width: 100% !important; table-layout: fixed !important; display: table !important; }
    td, th { word-wrap: break-word; overflow-wrap: break-word; }
    .text-area img, .text-area svg { width: auto !important; height: auto !important; max-width: 100% !important; display: block; margin: 10px auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

    .divider { display: none; border: 0; border-top: 2px dashed var(--border); margin: 30px 0; position: relative; }
    .divider::after { content: "ì •ë‹µ"; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--surface); padding: 0 10px; color: var(--text-sub); font-size: 0.8rem; font-weight: bold; }
    #answer-section { display: none; padding-bottom: 20px; }

    .footer { width: 100%; padding: 10px 20px; padding-bottom: calc(35px + env(safe-area-inset-bottom)); background: var(--surface); border-top: 1px solid var(--border); z-index: 10; display: flex; flex-direction: column; gap: 10px; justify-content: center; }
    .nav-btns, .grade-btns { display: flex; justify-content: space-between; gap: 12px; }
    .nav-btn, .g-btn { flex: 1; padding: 14px 0; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; text-align: center; border: none; }
    .nav-btn { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); }
    .bg-x { background: #fa5252; color: white; } .bg-tri { background: #fab005; color: white; } .bg-o { background: #40c057; color: white; }
    .click-guide { text-align: center; color: var(--text-sub); font-size: 0.9rem; margin-top: 40px; cursor: pointer; padding: 30px; border: 2px dashed var(--border); border-radius: 12px; background: #181818; pointer-events: auto !important; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; justify-content: center; }
    .modal-content { background: var(--surface); width: 90%; max-width: 500px; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 15px; border: 1px solid var(--border); }
    .edit-input { width: 100%; padding: 10px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); border-radius: 8px; font-family: inherit; font-size: 1rem; resize: vertical; min-height: 80px; }
    .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
    .modal-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
    .btn-save { background: var(--primary); color: white; } .btn-cancel { background: var(--input-bg); color: var(--text); }
    #loading { margin-top: 50%; color: var(--text-sub); text-align: center; }
    .ox-highlight { font-size: 4rem; font-weight: 900; text-align: center; display: block; margin: 10px 0; }
    .ox-o { color: #40c057; } .ox-x { color: #fa5252; }
</style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <h2 style="margin-top:0; color:var(--text); font-size:1.4rem;">âš™ï¸ ì„¤ì •</h2>
        <div class="menu-section">
            <span class="menu-label">ğŸ“Š ì •ë ¬ ê¸°ì¤€</span>
            <div class="sort-options">
                <div class="sort-opt" id="sort-wrong" onclick="setSortMode('wrong')">ğŸ”¥ í‹€ë¦°ìˆœ</div>
                <div class="sort-opt" id="sort-normal" onclick="setSortMode('normal')">ğŸ“‹ ì›ë˜ìˆœ</div>
                <div class="sort-opt" id="sort-random" onclick="setSortMode('random')">ğŸ² ëœë¤</div>
            </div>
        </div>
        <div class="menu-section">
            <span class="menu-label">ğŸ·ï¸ í•„í„° (ëª¨ì•„ë³´ê¸°)</span>
            <div class="filter-grid">
                <button class="filter-btn" id="filter-all" onclick="filterCards('default')">ğŸ“ ì „ì²´ ë³´ê¸°</button>
                <button class="filter-btn" id="filter-fav" onclick="filterCards('fav')">â­ ì¤‘ìš” ëª¨ìŒ</button>
                <button class="filter-btn" id="filter-mem" onclick="filterCards('mem')">ğŸ§  ì•”ê¸° ëª¨ìŒ</button>
                <button class="filter-btn" id="filter-cmp" onclick="filterCards('cmp')">ğŸ†š ë¹„êµ ëª¨ìŒ</button>
                <button class="filter-btn" id="filter-num" onclick="filterCards('num')">ğŸ”¢ ìˆ«ì ëª¨ìŒ</button>
                <button class="filter-btn" id="filter-date" onclick="filterCards('date')">ğŸ“… ë‚ ì§œ ëª¨ìŒ</button>
                <button class="filter-btn" id="filter-pen" onclick="filterCards('pen')">ğŸš¨ ë²Œì¹™ ëª¨ìŒ</button>
            </div>
        </div>
        <div class="menu-section">
            <span class="menu-label">ğŸ” ê²€ìƒ‰</span>
            <input type="text" id="search-input" class="search-input" placeholder="í…ìŠ¤íŠ¸, OCR ê²€ìƒ‰" onkeyup="filterCards('search')">
        </div>
        <div class="menu-section">
            <span class="menu-label">ë°ì´í„° & ì„¤ì •</span>
            <button class="btn-upload" onclick="document.getElementById('file-input').click()">+ í…ìŠ¤íŠ¸ íŒŒì¼ ì¶”ê°€</button>
            <input type="file" id="file-input" accept=".txt" multiple style="display:none" onchange="handleFileUpload(this)">
            <button class="btn-sub" onclick="document.getElementById('img-input').click()">ğŸ–¼ï¸ ì´ë¯¸ì§€ í´ë” ì—°ê²°</button>
            <input type="file" id="img-input" webkitdirectory directory multiple style="display:none" onchange="handleImgUpload(this)">
            <button class="btn-sub" onclick="exportData()">ğŸ’¾ ë°±ì—… ì €ì¥</button>
            <button class="btn-sub" onclick="document.getElementById('backup-input').click()">ğŸ“‚ ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input type="file" id="backup-input" accept=".json" style="display:none" onchange="importData(this)">
        </div>
        <ul class="deck-list" id="deck-list-ui"></ul>
        <div style="height:50px;"></div>
    </div>

    <div class="header">
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <div class="header-title-area">
            <div class="header-title" id="deck-title">ë‚˜ë§Œì˜ ì•ˆí‚¤</div>
            <div class="header-subtitle" id="sort-info">ğŸ”¥ í‹€ë¦° ìˆœ ì •ë ¬</div>
        </div>
        <div class="header-controls"><span class="counter" id="card-counter">0 / 0</span></div>
    </div>

    <div class="main-container">
        <div class="card">
            <div class="card-scroll-area" id="scroll-area">
                <div class="zoom-content" id="zoom-content">
                    <div id="loading" style="display:none;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                    <div class="card-info" id="card-info">
                        <div style="display:flex; align-items:center;">
                            <span class="rate-badge" id="rate-badge">New</span>
                            <span class="date-badge" id="date-badge" style="display:none;"></span>
                        </div>
                        <div class="icon-wrapper">
                            <div class="icon-row">
                                <button class="icon-btn edit-btn" onclick="openEditModal(event)">âœï¸</button>
                                <button class="icon-btn mem-btn" id="mem-btn" onclick="toggleTag(event, 'mem')">ğŸ§ </button>
                                <button class="icon-btn cmp-btn" id="cmp-btn" onclick="toggleTag(event, 'cmp')">ğŸ†š</button>
                                <button class="icon-btn fav-btn" id="fav-btn" onclick="toggleTag(event, 'fav')">â­</button>
                            </div>
                            <div class="icon-row">
                                <button class="icon-btn num-btn" id="num-btn" onclick="toggleTag(event, 'num')">ğŸ”¢</button>
                                <button class="icon-btn date-btn" id="date-btn" onclick="toggleTag(event, 'date')">ğŸ“…</button>
                                <button class="icon-btn pen-btn" id="pen-btn" onclick="toggleTag(event, 'pen')">ğŸš¨</button>
                            </div>
                        </div>
                    </div>
                    <div id="question-section" class="content-box"></div>
                    <div id="click-guide" class="click-guide" onclick="revealAnswer(event)">ğŸ‘‡ í„°ì¹˜í•˜ì—¬ ì •ë‹µ í™•ì¸</div>
                    <hr id="divider" class="divider">
                    <div id="answer-section" class="content-box"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="grade-btns" id="grade-area">
            <button class="g-btn bg-x" onclick="grade(0)">ëª¨ë¦„</button>
            <button class="g-btn bg-tri" onclick="grade(1)">ì• ë§¤</button>
            <button class="g-btn bg-o" onclick="grade(2)">ë§ìŒ</button>
        </div>
        <div class="nav-btns" id="nav-area">
            <button class="nav-btn" onclick="moveCard(-1)">â—€ ì´ì „</button>
            <button class="nav-btn" onclick="moveCard(1)">ë‹¤ìŒ â–¶</button>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“ ì¹´ë“œ ìˆ˜ì •</div>
            <div><span class="edit-label">ì§ˆë¬¸ (Front)</span><textarea id="edit-q" class="edit-input"></textarea></div>
            <div><span class="edit-label">ì •ë‹µ (Back)</span><textarea id="edit-a" class="edit-input"></textarea></div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeEditModal()">ì·¨ì†Œ</button>
                <button class="modal-btn btn-save" onclick="saveEdit()">ì €ì¥</button>
            </div>
        </div>
    </div>

<script>
    const repoOwner = 'minkunai87-ai';
    const repoName = 'mk';
    const githubRawBase = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/images/`;

    // í•€ì¹˜ ì¤Œ ë¡œì§
    const scrollContainer = document.getElementById('scroll-area');
    const zoomContent = document.getElementById('zoom-content');
    let scale = 1, panning = false, pointX = 0, pointY = 0, startX = 0, startY = 0, lastTap = 0, startDist = 0, startScale = 1;

    scrollContainer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) { e.preventDefault(); panning = false; startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); startScale = scale; }
        else if (e.touches.length === 1) { const now = new Date().getTime(); if (now - lastTap < 300) { e.preventDefault(); resetZoom(); } else { if (scale > 1) { panning = true; startX = e.touches[0].pageX - pointX; startY = e.touches[0].pageY - pointY; } } lastTap = now; }
    }, { passive: false });

    scrollContainer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) { e.preventDefault(); const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); scale = Math.min(Math.max(1, startScale * (dist / startDist)), 4); updateTransform(); }
        else if (e.touches.length === 1 && panning && scale > 1) { e.preventDefault(); pointX = e.touches[0].pageX - startX; pointY = e.touches[0].pageY - startY; updateTransform(); }
    }, { passive: false });

    scrollContainer.addEventListener('touchend', (e) => { if (e.touches.length < 2) panning = false; if (scale < 1.1) resetZoom(); });
    function resetZoom() { scale = 1; pointX = 0; pointY = 0; updateTransform(); scrollContainer.style.overflowY = 'auto'; }
    function updateTransform() { if (scale > 1) scrollContainer.style.overflow = 'hidden'; else scrollContainer.style.overflowY = 'auto'; zoomContent.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }

    // ì•ˆí‚¤ ë¡œì§
    let library = {}, currentDeckName = null, originalDeck = [], activeDeck = [], currentIndex = 0, imageMap = new Map();
    let currentFilterType = 'default', currentSortMode = 'wrong';
    const STORAGE_KEY_LIBRARY = 'anki_final_library', STORAGE_KEY_STATS = 'anki_final_stats', STORAGE_KEY_EDITS = 'anki_final_edits';
    const STORAGE_KEY_PROGRESS = 'anki_final_progress', STORAGE_KEY_LAST_DECK = 'anki_final_last_deck', STORAGE_KEY_IS_GROUP = 'anki_final_is_group', STORAGE_KEY_SORT = 'anki_final_sort_mode';

    window.onload = async function() {
        currentSortMode = localStorage.getItem(STORAGE_KEY_SORT) || 'wrong';
        updateSortUI();
        if (location.protocol.startsWith('http')) { await autoScanGitHub(); } else { loadLocalLibrary(); }
    };

    function updateSortUI() {
        ['wrong', 'normal', 'random'].forEach(m => document.getElementById(`sort-${m}`).classList.toggle('active', currentSortMode === m));
        const labels = { 'wrong': 'ğŸ”¥ í‹€ë¦° ìˆœ ì •ë ¬', 'normal': 'ğŸ“‹ ì›ë˜ ìˆœì„œ', 'random': 'ğŸ² ëœë¤ ì •ë ¬' };
        document.getElementById('sort-info').innerText = labels[currentSortMode];
    }

    function setSortMode(mode) {
        currentSortMode = mode;
        localStorage.setItem(STORAGE_KEY_SORT, mode);
        updateSortUI();
        if(currentDeckName) { applySort(); currentIndex = 0; showCard(); toggleMenu(false); }
    }

    function applySort() {
        if (!activeDeck || activeDeck.length === 0) return;
        const allStats = JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || '{}');
        if (currentSortMode === 'wrong') {
            activeDeck.sort((a, b) => {
                const sA = allStats[a.id] || {correct:0, total:0}; const sB = allStats[b.id] || {correct:0, total:0};
                const rA = sA.total === 0 ? 0 : sA.correct / sA.total; const rB = sB.total === 0 ? 0 : sB.correct / sB.total;
                if (rA !== rB) return rA - rB;
                return sA.total - sB.total;
            });
        } else if (currentSortMode === 'random') {
            activeDeck.sort(() => Math.random() - 0.5);
        }
    }

    function getDaysText(lastTimestamp) {
        if (!lastTimestamp) return "";
        const now = new Date(); const todayStart = new Date(now);
        if (now.getHours() < 4) todayStart.setDate(todayStart.getDate() - 1);
        todayStart.setHours(4, 0, 0, 0);
        const diff = todayStart.getTime() - lastTimestamp;
        if (diff < 0) return "âœ… ì˜¤ëŠ˜ ì™„ë£Œ";
        const days = Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
        return `ğŸ•’ ${days}ì¼ ì „`;
    }

    function saveProgress() {
        if (!currentDeckName) return;
        const progress = JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESS) || '{}');
        progress[`${currentDeckName}__${currentFilterType}`] = currentIndex;
        localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify(progress));
    }

    function loadLocalLibrary() {
        const savedLib = localStorage.getItem(STORAGE_KEY_LIBRARY);
        if (savedLib) {
            try {
                library = JSON.parse(savedLib);
                renderDeckTree();
                const lastDeck = localStorage.getItem(STORAGE_KEY_LAST_DECK);
                const isGroup = localStorage.getItem(STORAGE_KEY_IS_GROUP) === 'true';
                if (lastDeck) { if (isGroup) selectDeckGroup(lastDeck); else if (library[lastDeck]) selectDeck(lastDeck); }
            } catch(e) {}
        }
    }

    async function autoScanGitHub() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('question-section').style.display = 'none';
        let loadedCount = 0; const edits = JSON.parse(localStorage.getItem(STORAGE_KEY_EDITS) || '{}');
        try {
            const listUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/`;
            const listResponse = await fetch(listUrl);
            if (!listResponse.ok) throw new Error("Repo access failed");
            const files = await listResponse.json();
            const txtFiles = files.filter(f => f.name.endsWith('.txt'));
            for (const file of txtFiles) {
                try {
                    const contentResponse = await fetch(file.download_url + '?t=' + new Date().getTime());
                    const text = await contentResponse.text();
                    processAnkiText(text, file.name, edits);
                    loadedCount++;
                } catch (e) {}
            }
        } catch (error) {}
        renderDeckTree();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('question-section').style.display = 'block';
        if (loadedCount > 0) {
            const lastDeck = localStorage.getItem(STORAGE_KEY_LAST_DECK);
            const isGroup = localStorage.getItem(STORAGE_KEY_IS_GROUP) === 'true';
            if (lastDeck) { if (isGroup) selectDeckGroup(lastDeck); else if (library[lastDeck]) selectDeck(lastDeck); } else selectDeck(Object.keys(library)[0]);
        } else { document.getElementById('question-section').innerHTML = "<h3>âš ï¸ ë¶ˆëŸ¬ì˜¬ ë±ì´ ì—†ìŠµë‹ˆë‹¤.</h3>"; }
    }

    function parseAnkiRawData(str) {
        const rows = []; let currentRow = []; let currentCell = ''; let cursor = 0; let inQuote = false;
        while (cursor < str.length) {
            const char = str[cursor]; const nextChar = str[cursor + 1];
            if (inQuote) { if (char === '"' && nextChar === '"') { currentCell += '"'; cursor += 2; } else if (char === '"') { inQuote = false; cursor++; } else { currentCell += char; cursor++; } }
            else { if (char === '"') { inQuote = true; cursor++; } else if (char === '\t') { currentRow.push(currentCell); currentCell = ''; cursor++; } else if (char === '\n' || char === '\r') { if (char === '\r' && nextChar === '\n') cursor++; currentRow.push(currentCell); if (currentRow.length > 1 || (currentRow.length === 1 && currentRow[0].trim() !== '')) { rows.push(currentRow); } currentRow = []; currentCell = ''; cursor++; } else { currentCell += char; cursor++; } }
        }
        if (currentRow.length > 0 || currentCell !== '') { currentRow.push(currentCell); rows.push(currentRow); }
        return rows;
    }

    function processAnkiText(text, filename, edits) {
        const rows = parseAnkiRawData(text);
        let currentDeck = filename.replace('.txt', '');
        rows.forEach(fields => {
            if (fields.length > 0 && fields[0].startsWith('#')) return;
            let deckNameInRow = null; let q = "", a = "";
            if (fields.length >= 3) { deckNameInRow = fields[0].replace(/::/g, '__'); q = fields[1]; a = fields.slice(2).join('<br>'); } 
            else { deckNameInRow = currentDeck; if (fields.length === 2) { q = fields[0]; a = fields[1]; } else if (fields.length > 0) { q = fields[0]; a = fields.slice(1).join('<br>'); } }
            if(!q) return;
            if (!library[deckNameInRow]) library[deckNameInRow] = [];
            const id = cyrb53(q);
            if (edits[id]) { q = edits[id].q; a = edits[id].a; }
            library[deckNameInRow].push({ id, q, a });
        });
    }

    // === ğŸ”¥ í•µì‹¬ ìˆ˜ì •: ì •ë°€ DOM íƒìƒ‰ìœ¼ë¡œ ì´ë¯¸ì§€ ëˆ„ë½ ë°©ì§€ ===
    function createDOM(rawText, isAnswer) {
        if (!rawText) rawText = "";
        let formattedText = rawText.replace(/""/g, '"');
        if (formattedText.startsWith('"') && formattedText.endsWith('"')) formattedText = formattedText.slice(1, -1);

        // 1. title ì†ì„± ì œê±°
        let cleanText = formattedText.replace(/title\s*=\s*"[^"]*"/gi, ''); 
        
        // 2. IO ì½”ë“œ ìˆ¨ê¸°ê¸°
        cleanText = cleanText.replace(/(\{\{c\d+::.*?\}\})/g, '<span style="display:none">$1</span>');

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cleanText;

        // ğŸ”¥ [ì´ë¯¸ì§€ ì •ë°€ ë³µêµ¬] ì •ê·œì‹ì´ ì•„ë‹ˆë¼ DOMìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ì°¾ì•„ì„œ src êµì²´
        tempDiv.querySelectorAll('img').forEach(img => {
            const src = img.getAttribute('src');
            if (src && !src.startsWith('http') && !src.startsWith('data:')) {
                // íŒŒì¼ëª…ë§Œ ì¶”ì¶œí•´ì„œ ê¹ƒí—™ ê²½ë¡œë¡œ êµì²´ (íŠ¹ìˆ˜ë¬¸ì/ê³µë°± ì²˜ë¦¬ ê°•í™”)
                const fname = src.trim();
                const url = imageMap.get(fname) || 
                            imageMap.get(fname.normalize('NFC')) || 
                            githubRawBase + encodeURIComponent(fname);
                img.src = url;
            }
            
            // ì—ëŸ¬ í•¸ë“¤ë§
            img.onerror = function() {
                // í˜¹ì‹œ ì´ë¯¸ì§€ê°€ ì•ˆ ëœ¨ë©´ í…Œë‘ë¦¬ë¡œ í‘œì‹œ
                this.style.border = "2px dashed #ff6b6b"; 
                // ì›ë³¸ íŒŒì¼ëª… í‘œì‹œ (ë””ë²„ê¹…ìš©)
                this.alt = "ì´ë¯¸ì§€ ì—†ìŒ: " + src;
            };
        });

        // ğŸ”¥ [ê°•ì œ ë‹¤ì´ì–´íŠ¸]
        tempDiv.querySelectorAll('*').forEach(el => {
            el.style.width = ""; el.style.height = ""; el.style.maxWidth = "100%"; el.style.minWidth = "0"; 
            el.removeAttribute("width"); el.removeAttribute("height");
            if(el.tagName === 'TABLE' || el.tagName === 'TD' || el.tagName === 'TH') {
                el.style.tableLayout = "fixed"; el.style.width = "100%"; el.removeAttribute("nowrap");
            }
        });

        const wrapper = document.createElement('div'); wrapper.className = 'answer-layout';
        const txtDiv = document.createElement('div'); txtDiv.className = 'text-area';
        
        let textContent = tempDiv.textContent.trim();
        const hasComplexTags = tempDiv.querySelector('div, svg, img'); 
        
        if (isAnswer && !hasComplexTags && (textContent.startsWith('O') || textContent.startsWith('X'))) {
             const firstChar = textContent.charAt(0);
             const oxSpan = document.createElement('span'); 
             oxSpan.className = `ox-highlight ${firstChar === 'O' ? 'ox-o' : 'ox-x'}`; 
             oxSpan.innerText = firstChar;
             txtDiv.appendChild(oxSpan);
             wrapper.appendChild(txtDiv);
             wrapper.appendChild(tempDiv);
        } else {
            wrapper.appendChild(tempDiv);
        }
        
        return wrapper;
    }

    function showCard() {
        resetZoom();
        if (!activeDeck || activeDeck.length === 0) {
            document.getElementById('question-section').innerHTML = "<h3 style='color:var(--text-sub)'>í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</h3>";
            document.getElementById('card-info').style.display='none';
            return;
        }
        if(currentIndex >= activeDeck.length) currentIndex = 0;
        
        isRevealed = false;
        const card = activeDeck[currentIndex];
        const stats = getStats(card.id);
        
        document.getElementById('card-counter').innerText = `${currentIndex + 1} / ${activeDeck.length}`;
        document.getElementById('card-info').style.display='flex';
        updateStatsUI(stats); updateIconsUI(stats);

        const dateBadge = document.getElementById('date-badge');
        const dateText = getDaysText(stats.last);
        if (dateText) { dateBadge.innerText = dateText; dateBadge.style.display = 'inline-block'; dateBadge.className = dateText.includes('ì˜¤ëŠ˜') ? 'date-badge today' : 'date-badge recent'; } 
        else { dateBadge.style.display = 'none'; }

        const qSection = document.getElementById('question-section'); qSection.innerHTML = '';
        qSection.appendChild(createDOM(card.q, false));
        
        const aSection = document.getElementById('answer-section'); aSection.innerHTML = '';
        aSection.appendChild(createDOM(card.a, true));
        
        aSection.style.display = 'none';
        document.getElementById('divider').style.display = 'none';
        document.getElementById('click-guide').style.display = 'block';
        document.getElementById('nav-area').style.display = 'flex';
        document.getElementById('grade-area').style.display = 'none';
        scrollContainer.scrollTop = 0;
    }

    function revealAnswer(event) {
        if(event) event.stopPropagation(); 
        document.getElementById('click-guide').style.display = 'none';
        document.getElementById('divider').style.display = 'block';
        document.getElementById('answer-section').style.display = 'block';
        document.getElementById('grade-area').style.display = 'flex';
        setTimeout(() => { document.getElementById('answer-section').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
    }

    function filterCards(type) { 
        if(!currentDeckName) return;
        if (type === 'search') {
            const rawQuery = document.getElementById('search-input').value.toLowerCase();
            if(!rawQuery) { activeDeck = [...originalDeck]; } 
            else { activeDeck = originalDeck.filter(card => card.q.toLowerCase().includes(rawQuery) || card.a.toLowerCase().includes(rawQuery)); }
        } else {
            currentFilterType = type;
            const allStats = JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || '{}');
            let newDeck = [...originalDeck];
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`filter-${type}`);
            if(activeBtn) activeBtn.classList.add('active');

            if (type !== 'default') {
                newDeck = newDeck.filter(c => (allStats[c.id] || {})[type]);
                if(newDeck.length === 0) { alert("í•´ë‹¹í•˜ëŠ” ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
            }
            activeDeck = newDeck;
        }
        applySort();
        const progress = JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESS) || '{}');
        const key = `${currentDeckName}__${currentFilterType}`;
        currentIndex = progress[key] || 0;
        if(currentIndex >= activeDeck.length) currentIndex = 0;
        showCard();
        toggleMenu(false);
    }

    function renderDeckTree() {
        const list = document.getElementById('deck-list-ui'); list.innerHTML = '';
        const names = Object.keys(library).sort();
        if (names.length === 0) { list.innerHTML = '<li class="deck-item" style="justify-content:center;">ë± ì—†ìŒ</li>'; return; }
        const tree = {};
        names.forEach(path => {
            const parts = path.split('__'); let currentLevel = tree;
            parts.forEach((part, index) => {
                if (!currentLevel[part]) { currentLevel[part] = { _name: part, _fullPath: parts.slice(0, index + 1).join('__'), _children: {}, _isLeaf: false }; }
                if (index === parts.length - 1 && library[path] && library[path].length > 0) { currentLevel[part]._isLeaf = true; }
                currentLevel = currentLevel[part]._children;
            });
        });
        function createTreeDOM(node, container) {
            const keys = Object.keys(node).sort();
            keys.forEach(key => {
                const item = node[key];
                const hasChildren = Object.keys(item._children).length > 0;
                if (hasChildren) { 
                    const li = document.createElement('li'); li.className = 'tree-folder';
                    const header = document.createElement('div'); header.className = 'tree-header';
                    const titleArea = document.createElement('div'); titleArea.className = 'folder-title';
                    const countInfo = item._isLeaf ? `(${library[item._fullPath].length})` : '';
                    titleArea.innerHTML = `<span class="folder-icon">ğŸ“‚</span> ${item._name} <small style="opacity:0.6; font-weight:normal;">${countInfo}</small>`;
                    const playBtn = document.createElement('button'); playBtn.className = 'play-btn'; playBtn.innerText = 'â–¶ ì „ì²´';
                    playBtn.onclick = (e) => { e.stopPropagation(); selectDeckGroup(item._fullPath + '__'); };
                    header.appendChild(titleArea); header.appendChild(playBtn); li.appendChild(header);
                    const childContainer = document.createElement('ul'); childContainer.className = 'tree-children deck-list';
                    header.onclick = () => { childContainer.classList.toggle('open'); };
                    if (currentDeckName && currentDeckName.startsWith(item._fullPath)) { childContainer.classList.add('open'); }
                    li.appendChild(childContainer); container.appendChild(li);
                    createTreeDOM(item._children, childContainer);
                } else { 
                    const li = document.createElement('li');
                    const header = document.createElement('div');
                    header.className = `tree-deck ${item._fullPath === currentDeckName ? 'active' : ''}`;
                    header.innerHTML = `<span>ğŸ“„ ${item._name} <small>(${library[item._fullPath].length})</small></span>`;
                    const delBtn = document.createElement('button'); delBtn.className = 'del-btn'; delBtn.innerText = 'x';
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteDeck(item._fullPath); };
                    header.appendChild(delBtn);
                    header.onclick = () => selectDeck(item._fullPath);
                    li.appendChild(header); container.appendChild(li);
                }
            });
        }
        createTreeDOM(tree, list);
    }

    function selectDeckGroup(prefix) {
        let mergedCards = [];
        Object.keys(library).forEach(key => { if (key.startsWith(prefix) || key === prefix.replace('__', '')) { mergedCards = mergedCards.concat(library[key]); } });
        if (mergedCards.length === 0) { const exactKey = prefix.replace(/__$/, ''); if(library[exactKey]) { selectDeck(exactKey); return; } alert("í•˜ìœ„ ë±ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        let displayName = prefix.replace(/__$/, '').split('__').pop();
        currentDeckName = prefix.replace(/__$/, ''); originalDeck = mergedCards; activeDeck = [...originalDeck];
        localStorage.setItem(STORAGE_KEY_LAST_DECK, currentDeckName);
        localStorage.setItem(STORAGE_KEY_IS_GROUP, 'true');
        filterCards('default');
        document.getElementById('search-input').value = '';
        document.getElementById('deck-title').innerText = `ğŸ“‚ ${displayName} (í†µí•© ${activeDeck.length}ê°œ)`;
        renderDeckTree(); showCard(); toggleMenu(false);
    }

    function selectDeck(name) {
        if(!library[name]) return;
        currentDeckName = name; originalDeck = library[name]; activeDeck = [...originalDeck];
        localStorage.setItem(STORAGE_KEY_LAST_DECK, name);
        localStorage.setItem(STORAGE_KEY_IS_GROUP, 'false');
        filterCards('default');
        document.getElementById('search-input').value = '';
        const displayName = name.split('__').pop();
        document.getElementById('deck-title').innerText = `ğŸ“„ ${displayName}`;
        renderDeckTree(); showCard(); toggleMenu(false);
    }

    function toggleMenu(force) {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        const isOpen = force !== undefined ? force : !sidebar.classList.contains('open');
        if (isOpen) { sidebar.classList.add('open'); overlay.classList.add('open'); setTimeout(() => { const active = document.querySelector('.tree-deck.active'); if(active) active.scrollIntoView({block:'center', behavior:'smooth'}); }, 300); } 
        else { sidebar.classList.remove('open'); overlay.classList.remove('open'); }
    }

    function getStats(id) { return JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || '{}')[id] || { correct: 0, total: 0, fav: false, mem: false, cmp: false, num: false, date: false, pen: false, last: 0 }; }
    function saveStats(id, score) { /* grade í•¨ìˆ˜ë¡œ ëŒ€ì²´ë¨ */ }
    function toggleTag(e, type) { e.stopPropagation(); const card = activeDeck[currentIndex]; const data = JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || '{}'); if(!data[card.id]) data[card.id] = { correct: 0, total: 0, fav: false, mem: false, cmp: false, num: false, date: false, pen: false, last: 0 }; data[card.id][type] = !data[card.id][type]; localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(data)); updateIconsUI(data[card.id]); }
    function updateStatsUI(stats) { const badge = document.getElementById('rate-badge'); if(stats.total === 0) { badge.innerText = "New"; badge.className = "rate-badge"; } else { const rate = Math.round((stats.correct/stats.total)*100); badge.innerText = `${rate}% (${stats.total}íšŒ)`; badge.className = `rate-badge ${rate>=80?'high':(rate<50?'low':'')}`; } }
    function updateIconsUI(stats) { document.getElementById('mem-btn').classList.toggle('active', stats.mem); document.getElementById('cmp-btn').classList.toggle('active', stats.cmp); document.getElementById('fav-btn').classList.toggle('active', stats.fav); document.getElementById('num-btn').classList.toggle('active', stats.num); document.getElementById('date-btn').classList.toggle('active', stats.date); document.getElementById('pen-btn').classList.toggle('active', stats.pen); }
    function exportData() { const data = { stats: localStorage.getItem(STORAGE_KEY_STATS), edits: localStorage.getItem(STORAGE_KEY_EDITS), progress: localStorage.getItem(STORAGE_KEY_PROGRESS), lastDeck: localStorage.getItem(STORAGE_KEY_LAST_DECK), timestamp: new Date().toLocaleString() }; const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,""); a.download = `anki_backup_${dateStr}.json`; a.click(); URL.revokeObjectURL(url); }
    function importData(input) { const file = input.files[0]; if (!file) return; if(!confirm("âš ï¸ í˜„ì¬ ê¸°ê¸°ì˜ ê¸°ë¡ì„ ë®ì–´ì”Œì›ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { input.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if(data.stats) localStorage.setItem(STORAGE_KEY_STATS, data.stats); if(data.edits) localStorage.setItem(STORAGE_KEY_EDITS, data.edits); if(data.progress) localStorage.setItem(STORAGE_KEY_PROGRESS, data.progress); if(data.lastDeck) localStorage.setItem(STORAGE_KEY_LAST_DECK, data.lastDeck); alert("âœ… ë³µêµ¬ ì™„ë£Œ!\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤."); location.reload(); } catch (err) { alert("âŒ ì˜ëª»ëœ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤."); } }; reader.readAsText(file); }
    
    function moveCard(delta) { 
        let nextIdx = currentIndex + delta; 
        if(nextIdx >= 0 && nextIdx < activeDeck.length) { currentIndex = nextIdx; saveProgress(); showCard(); } 
    }
    function grade(score) { 
        const card = activeDeck[currentIndex];
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || '{}');
        if(!data[card.id]) data[card.id] = { correct: 0, total: 0, fav: false, mem: false, cmp: false, num: false, date: false, pen: false, last: 0 };
        data[card.id].total++;
        if(score === 2) data[card.id].correct++;
        else if(score === 1) data[card.id].correct += 0.5;
        data[card.id].last = Date.now();
        localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(data));
        updateStatsUI(data[card.id]);
        if (currentIndex < activeDeck.length - 1) { currentIndex++; saveProgress(); showCard(); } 
        else { alert("ë!"); currentIndex = 0; saveProgress(); showCard(); } 
    }

    const cyrb53 = (str, seed = 0) => { let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed; for (let i = 0, ch; i < str.length; i++) { ch = str.charCodeAt(i); h1 = Math.imul(h1 ^ ch, 2654435761); h2 = Math.imul(h2 ^ ch, 1597334677); } h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507) ^ Math.imul(h2 ^ (h2 >>> 13), 3266489909); return 4294967296 * (2097151 & h2) + (h1 >>> 0); };
</script>
</body>
</html>